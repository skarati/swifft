#include <stdio.h>
#include <stdlib.h>
#include <immintrin.h>
#include "measurement.h"
#include<malloc.h>
#include<string.h>
#include <inttypes.h>
#include <stdint.h>

#define align __attribute__ ((aligned (16)))

#if !defined (ALIGN16)
	# if defined (__GNUC__)
		# define ALIGN32 __attribute__ ( (aligned (16)))
	# else
		# define ALIGN32 __declspec (align (16))
	# endif
#endif

#define repeat 1000
typedef __m256i vec;
typedef int8_t  u8;
typedef int16_t u16;
typedef int32_t u32;
typedef int64_t u64;


const int p = 257;
const int omega = 42;
const vec allone = {-1,-1,-1,-1};
const vec zero = {0,0,0,0};
/*====Gobal variables====*/
const u32 pow_omega[128] align = { 1,  42, 222,  72, 197,  50,  44,  49,   2,  84, 187, 144, 137, 100,  88,  98,
			           4, 168, 117,  31,  17, 200, 176, 196,   8,  79, 234,  62,  34, 143,  95, 135,
			          16, 158, 211, 124,  68,  29, 190,  13,  32,  59, 165, 248, 136,  58, 123,  26,
			          64, 118,  73, 239,  15, 116, 246,  52, 128, 236, 146, 221,  30, 232, 235, 104,
			         256, 215,  35, 185,  60, 207, 213, 208, 255, 173,  70, 113, 120, 157, 169, 159,
			         253,  89, 140, 226, 240,  57,  81,  61, 249, 178,  23, 195, 223, 114, 162, 122,
			         241,  99,  46, 133, 189, 228,  67, 244, 225, 198,  92,   9, 121, 199, 134, 231,
			         193, 139, 184,  18, 242, 141,  11, 205, 129,  21, 111,  36, 227,  25,  22, 153};

const vec T_K0_I0[256] align = {{0, 0, 0, 0}, {4294967297, 4294967297, 4294967297, 4294967297}, {34359738370, 549755813920, 1069446856959, 554050781409},
{38654705667, 554050781217, 1073741824256, 558345748706}, {274877906948, 828928688381, 274877906948, 828928688381}, {279172874245, 833223655678, 279172874245, 833223655678},
{309237645318, 274877906972, 240518168578, 279172874461}, {313532612615, 279172874269, 244813135875, 283467841758}, {1095216660488, 137438953601, 8589934841, 966367641728},
{1099511627785, 141733920898, 12884902138, 970662609025}, {25769803786, 687194767521, 1078036791543, 416611827808}, {30064771083, 691489734818, 1082331758840, 420906795105},
{266287972364, 966367641725, 283467841789, 691489734780}, {270582939661, 970662609022, 287762809086, 695784702077}, {300647710734, 412316860573, 249108103419, 141733920860},
{304942678031, 416611827870, 253403070716, 146028888157}, {1035087118352, 1035087118352, 1035087118352, 1035087118352}, {1039382085649, 1039382085649, 1039382085649, 1039382085649},
{1069446856722, 481036337200, 1000727379982, 485331304689}, {1073741824019, 485331304497, 1005022347279, 489626271986}, {206158430228, 760209211404, 206158430228, 760209211404},
{210453397525, 764504178701, 210453397525, 764504178701}, {240518168598, 206158430252, 171798691858, 210453397741}, {244813135895, 210453397549, 176093659155, 214748365038},
{1026497183768, 68719476881, 1043677052936, 897648165008}, {1030792151065, 73014444178, 1047972020233, 901943132305}, {1060856922138, 618475290801, 1009317314566, 347892351088},
{1065151889435, 622770258098, 1013612281863, 352187318385}, {197568495644, 897648165005, 214748364812, 622770258060}, {201863462941, 901943132302, 219043332109, 627065225357},
{231928234014, 343597383853, 180388626442, 73014444140}, {236223201311, 347892351150, 184683593739, 77309411437}, {554050781216, 34359738623, 549755814113, 1069446856706},
{558345748513, 38654705920, 554050781410, 1073741824003}, {588410519586, 584115552286, 515396075743, 519691043043}, {592705486883, 588410519583, 519691043040, 523986010340},
{828928688164, 863288426747, 824633721061, 794568950015}, {833223655461, 867583394044, 828928688358, 798863917312}, {863288426534, 309237645338, 790273982691, 244813136095},
{867583393831, 313532612635, 794568949988, 249108103392}, {545460846632, 171798691967, 558345748697, 932007903362}, {549755813929, 176093659264, 562640715994, 936302870659},
{579820585002, 721554505887, 523986010327, 382252089442}, {584115552299, 725849473184, 528280977624, 386547056739}, {820338753580, 1000727380091, 833223655645, 657129996414},
{824633720877, 1005022347388, 837518622942, 661424963711}, {854698491950, 446676598939, 798863917275, 107374182494}, {858993459247, 450971566236, 803158884572, 111669149791},
{485331304496, 1069446856718, 481036337393, 1000727379986}, {489626271793, 1073741824015, 485331304690, 1005022347283}, {519691042866, 515396075566, 446676599023, 450971566323},
{523986010163, 519691042863, 450971566320, 455266533620}, {760209211444, 794568949770, 755914244341, 725849473038}, {764504178741, 798863917067, 760209211638, 730144440335},
{794568949814, 240518168618, 721554505971, 176093659375}, {798863917111, 244813135915, 725849473268, 180388626672}, {476741369912, 103079215247, 489626271977, 863288426642},
{481036337209, 107374182544, 493921239274, 867583393939}, {511101108282, 652835029167, 455266533607, 313532612722}, {515396075579, 657129996464, 459561500904, 317827580019},
{751619276860, 932007903371, 764504178925, 588410519694}, {755914244157, 936302870668, 768799146222, 592705486991}, {785979015230, 377957122219, 730144440555, 38654705774},
{790273982527, 382252089516, 734439407852, 42949673071}, {17179869248, 1086626726081, 17179869248, 1086626726081}, {21474836545, 1090921693378, 21474836545, 1090921693378},
{51539607618, 532575944929, 1086626725950, 536870912161}, {55834574915, 536870912226, 1090921693247, 541165879458}, {292057776196, 811748819133, 292057776196, 811748819133},
{296352743493, 816043786430, 296352743493, 816043786430}, {326417514566, 257698037981, 257698037826, 261993005213}, {330712481863, 261993005278, 261993005123, 266287972510},
{8589934664, 120259084353, 25769803832, 949187772480}, {12884901961, 124554051650, 30064771129, 953482739777}, {42949673034, 670014898273, 1095216660534, 399431958560},
{47244640331, 674309865570, 1099511627831, 403726925857}, {283467841612, 949187772477, 300647710780, 674309865532}, {287762808909, 953482739774, 304942678077, 678604832829},
{317827579982, 395136991325, 266287972410, 124554051612}, {322122547279, 399431958622, 270582939707, 128849018909}, {1052266987600, 1017907249361, 1052266987600, 1017907249361},
{1056561954897, 1022202216658, 1056561954897, 1022202216658}, {1086626725970, 463856468209, 1017907249230, 468151435441}, {1090921693267, 468151435506, 1022202216527, 472446402738},
{223338299476, 743029342413, 223338299476, 743029342413}, {227633266773, 747324309710, 227633266773, 747324309710},  {257698037846, 188978561261, 188978561106, 193273528493},
{261993005143, 193273528558, 193273528403, 197568495790}, {1043677053016, 51539607633, 1060856922184, 880468295760}, {1047972020313, 55834574930, 1065151889481, 884763263057},
{1078036791386, 601295421553, 1026497183814, 330712481840}, {1082331758683, 605590388850, 1030792151111, 335007449137}, {214748364892, 880468295757, 231928234060, 605590388812},
{219043332189, 884763263054, 236223201357, 609885356109}, {249108103262, 326417514605, 197568495690, 55834574892}, {253403070559, 330712481902, 201863462987, 60129542189},
{571230650464, 17179869375, 566935683104, 1052266987715}, {575525617761, 21474836672, 571230650401, 1056561955012}, {605590388834, 566935683295, 532575944734, 502511173795},
{609885356131, 571230650592, 536870912031, 506806141092}, {846108557412, 846108557499, 841813590052, 777389080767}, {850403524709, 850403524796, 846108557349, 781684048064},
{880468295782, 292057776347, 807453851682, 227633266847}, {884763263079, 296352743644, 811748818979, 231928234144}, {562640715880, 154618822719, 575525617688, 914828034114},
{566935683177, 158913790016, 579820584985, 919123001411}, {597000454250, 704374636639, 541165879318, 365072220194}, {601295421547, 708669603936, 545460846615, 369367187491},
{837518622828, 983547510843, 850403524636, 639950127166}, {841813590125, 987842478140, 854698491933, 644245094463}, {871878361198, 429496729691, 816043786266, 90194313246},
{876173328495, 433791696988, 820338753563, 94489280543}, {502511173744, 1052266987727, 498216206384, 983547510995}, {506806141041, 1056561955024, 502511173681, 987842478292},
{536870912114, 498216206575, 463856468014, 433791697075}, {541165879411, 502511173872, 468151435311, 438086664372}, {777389080692, 777389080779, 773094113332, 708669604047},
{781684047989, 781684048076, 777389080629, 712964571344}, {811748819062, 223338299627, 738734374962, 158913790127}, {816043786359, 227633266924, 743029342259, 163208757424},
{493921239160, 85899345999, 506806140968, 846108557394}, {498216206457, 90194313296, 511101108265, 850403524691}, {528280977530, 635655159919, 472446402598, 296352743474},
{532575944827, 639950127216, 476741369895, 300647710771}, {768799146108, 914828034123, 781684047916, 571230650446}, {773094113405, 919123001420, 785979015213, 575525617743},
{803158884478, 360777252971, 747324309546, 21474836526}, {807453851775, 365072220268, 751619276843, 25769803823}, {137438953600, 8589934600, 966367641729, 1095216660729},
{141733920897, 12884901897, 970662609026, 1099511628026}, {171798691970, 558345748520, 932007903359, 545460846809}, {176093659267, 562640715817, 936302870656, 549755814106},
{412316860548, 837518622724, 137438953605, 820338753781}, {416611827845, 841813590021, 141733920902, 824633721078}, {446676598918, 283467841572, 103079215235, 270582939861},
{450971566215, 287762808869, 107374182532, 274877907158}, {128849019016, 146028888201, 974957576313, 957777707128}, {133143986313, 150323855498, 979252543610, 962072674425},
{163208757386, 695784702121, 940597837943, 408021893208}, {167503724683, 700079669418, 944892805240, 412316860505}, {403726925964, 974957576325, 146028888189, 682899800180},
{408021893261, 979252543622, 150323855486, 687194767477}, {438086664334, 420906795173, 111669149819, 133143986260}, {442381631631, 425201762470, 115964117116, 137438953557},
{68719476880, 1043677052952, 897648165009, 1026497183752}, {73014444177, 1047972020249, 901943132306, 1030792151049}, {103079215250, 489626271800, 863288426639, 476741370089},
{107374182547, 493921239097, 867583393936, 481036337386}, {343597383828, 768799146004, 68719476885, 751619276804}, {347892351125, 773094113301, 73014444182, 755914244101},
{377957122198, 214748364852, 34359738515, 201863463141}, {382252089495, 219043332149, 38654705812, 206158430438}, {60129542296, 77309411481, 906238099593, 889058230408},
{64424509593, 81604378778, 910533066890, 893353197705}, {94489280666, 627065225401, 871878361223, 339302416488}, {98784247963, 631360192698, 876173328520, 343597383785},
{335007449244, 906238099605, 77309411469, 614180323460}, {339302416541, 910533066902, 81604378766, 618475290757}, {369367187614, 352187318453, 42949673099, 64424509540},
{373662154911, 356482285750, 47244640396, 68719476837}, {691489734816, 42949672966, 412316860513, 1060856922363}, {695784702113, 47244640263, 416611827810, 1065151889660},
{725849473186, 592705486886, 377957122143, 511101108443}, {730144440483, 597000454183, 382252089440, 515396075740}, {966367641764, 871878361090, 687194767461, 785979015415},
{970662609061, 876173328387, 691489734758, 790273982712}, {1000727380134, 317827579938, 652835029091, 236223201495}, {1005022347431, 322122547235, 657129996388, 240518168792},
{682899800232, 180388626567, 420906795097, 923417968762}, {687194767529, 184683593864, 425201762394, 927712936059}, {717259538602, 730144440487, 386547056727, 373662154842},
{721554505899, 734439407784, 390842024024, 377957122139}, {957777707180, 1009317314691, 695784702045, 648540061814}, {962072674477, 1013612281988, 700079669342, 652835029111},
{992137445550, 455266533539, 661424963675, 98784247894}, {996432412847, 459561500836, 665719930972, 103079215191}, {622770258096, 1078036791318, 343597383793, 992137445386},
{627065225393, 1082331758615, 347892351090, 996432412683}, {657129996466, 523986010166, 309237645423, 442381631723}, {661424963763, 528280977463, 313532612720, 446676599020},
{897648165044, 803158884370, 618475290741, 717259538438}, {901943132341, 807453851667, 622770258038, 721554505735}, {932007903414, 249108103218, 584115552371, 167503724775},
{936302870711, 253403070515, 588410519668, 171798692072}, {614180323512, 111669149847, 352187318377, 854698492042}, {618475290809, 115964117144, 356482285674, 858993459339},
{648540061882, 661424963767, 317827580007, 304942678122}, {652835029179, 665719931064, 322122547304, 309237645419}, {889058230460, 940597837971, 627065225325, 579820585094},
{893353197757, 944892805268, 631360192622, 584115552391}, {923417968830, 386547056819, 592705486955, 30064771174}, {927712936127, 390842024116, 597000454252, 34359738471},
{154618822848, 1095216660681, 983547510977, 1078036791481}, {158913790145, 1099511627978, 987842478274, 1082331758778}, {188978561218, 541165879529, 949187772607, 528280977561},
{193273528515, 545460846826, 953482739904, 532575944858}, {429496729796, 820338753733, 154618822853, 803158884533},  {433791697093, 824633721030, 158913790150, 807453851830},
{463856468166, 266287972581, 120259084483, 253403070613}, {468151435463, 270582939878, 124554051780, 257698037910}, {146028888264, 128849018953, 992137445561, 940597837880},
{150323855561, 133143986250, 996432412858, 944892805177}, {180388626634, 678604832873, 957777707191, 390842023960}, {184683593931, 682899800170, 962072674488, 395136991257},
{420906795212, 957777707077, 163208757437, 665719930932}, {425201762509, 962072674374, 167503724734, 670014898229}, {455266533582, 403726925925, 128849019067, 115964117012},
{459561500879, 408021893222, 133143986364, 120259084309}, {85899346128, 1026497183961, 914828034257, 1009317314761}, {90194313425, 1030792151258, 919123001554, 1013612282058},
{120259084498, 472446402809, 880468295887, 459561500841}, {124554051795, 476741370106, 884763263184, 463856468138}, {360777253076, 751619277013, 85899346133, 734439407813},
{365072220373, 755914244310, 90194313430, 738734375110}, {395136991446, 197568495861, 51539607763, 184683593893}, {399431958743, 201863463158, 55834575060, 188978561190},
{77309411544, 60129542233, 923417968841, 871878361160}, {81604378841, 64424509530, 927712936138, 876173328457}, {111669149914, 609885356153, 889058230471, 322122547240},
{115964117211, 614180323450, 893353197768, 326417514537}, {352187318492, 889058230357, 94489280717, 597000454212}, {356482285789, 893353197654, 98784248014, 601295421509},
{386547056862, 335007449205, 60129542347, 47244640292}, {390842024159, 339302416502, 64424509644, 51539607589}, {708669604064, 25769803975, 429496729761, 1043677053115},
{712964571361, 30064771272, 433791697058, 1047972020412}, {743029342434, 575525617895, 395136991391, 493921239195}, {747324309731, 579820585192, 399431958688, 498216206492},
{983547511012, 854698492099, 704374636709, 768799146167}, {987842478309, 858993459396, 708669604006, 773094113464}, {1017907249382, 300647710947, 670014898339, 219043332247},
{1022202216679, 304942678244, 674309865636, 223338299544}, {700079669480, 163208757319, 438086664345, 906238099514}, {704374636777, 167503724616, 442381631642, 910533066811},
{734439407850, 712964571239, 403726925975, 356482285594}, {738734375147, 717259538536, 408021893272, 360777252891}, {974957576428, 992137445443, 712964571293, 631360192566},
{979252543725, 996432412740, 717259538590, 635655159863}, {1009317314798, 438086664291, 678604832923, 81604378646}, {1013612282095, 442381631588, 682899800220, 85899345943},
{639950127344, 1060856922327, 360777253041, 974957576395}, {644245094641, 1065151889624, 365072220338, 979252543692}, {674309865714, 506806141175, 326417514671, 425201762475},
{678604833011, 511101108472, 330712481968, 429496729772}, {914828034292, 785979015379, 635655159989, 700079669447}, {919123001589, 790273982676, 639950127286, 704374636744},
{949187772662, 231928234227, 601295421619, 150323855527}, {953482739959, 236223201524, 605590388916, 154618822824}, {631360192760, 94489280599, 369367187625, 837518622794},
{635655160057, 98784247896, 373662154922, 841813590091}, {665719931130, 644245094519, 335007449255, 287762808874}, {670014898427, 648540061816, 339302416552, 292057776171},
{906238099708, 923417968723, 644245094573, 562640715846}, {910533067005, 927712936020, 648540061870, 566935683143}, {940597838078, 369367187571, 609885356203, 12884901926},
{944892805375, 373662154868, 614180323500, 17179869223}};

const vec M_K0_I0[8] align = {{4294967297, 4294967297, 4294967297, 4294967297}, {309237645354, 210453397554, 618475290708, 420906795108}, {188978561246, 377957122235, 755914244213, 408021893354},
			      {360777252936, 858993459298, 678604832830, 249108103181}, {588410519749, 146028888081, 584115552324, 128849018895}, {420906795058, 532575944783, 223338299450, 485331304663},
			      {502511173676, 708669603935, 150323855606, 98784247977}, {858993459249, 506806141052, 674309865576, 850403524803}};

const vec mask255 = {0xff000000ff,0xff000000ff,0xff000000ff,0xff000000ff};
const vec p257 = {0x10100000101,0x10100000101,0x10100000101,0x10100000101};
const vec p257_3 = {0x80800000808,0x80800000808,0x80800000808,0x80800000808};
const vec p257_5 = {0x202000002020,0x202000002020,0x202000002020,0x202000002020};
const vec p257_7 = {0x808000008080,0x808000008080,0x808000008080,0x808000008080};
const vec permute[8] = 	{{0x000000000,0x000000000,0x000000000,0x000000000},
			 {0x100000001,0x100000001,0x100000001,0x100000001},
			 {0x200000002,0x200000002,0x200000002,0x200000002},
		 	 {0x300000003,0x300000003,0x300000003,0x300000003},
			 {0x400000004,0x400000004,0x400000004,0x400000004},
			 {0x500000005,0x500000005,0x500000005,0x500000005},
			 {0x600000006,0x600000006,0x600000006,0x600000006},
			 {0x700000007,0x700000007,0x700000007,0x700000007}};
const vec k0i0[8] = {{ 0x100000001, 0x100000001, 0x100000001, 0x100000001 },
		 { 0x800000002, 0x8000000020, 0xF9000000FF, 0x81000000E1},
		 { 0x4000000004, 0xC1000000FD, 0x4000000004, 0xC1000000FD},
		 { 0xFF00000008, 0x2000000081, 0x2000000F9, 0xE100000080 },
		 { 0xF100000010, 0xF100000010, 0xF100000010, 0xF100000010 },
		 { 0x8100000020, 0x8000000FF, 0x80000000E1, 0xF900000002 },
		 { 0x400000040, 0xFD000000C1, 0x400000040, 0xFD000000C1 },
		 { 0x2000000080, 0x200000008, 0xE100000081, 0xFF000000F9 }};

void create_x(int x[16][64]);
void print_x(int x[16][64]);
void ReduceY(vec *Y);
void ReduceY_final(vec *Y);
inline void unpackY(vec Y[8]);
inline void outputY(u32 Y[8][8]);
inline void SWIFFT(int x[16][64]);
inline void set_Key();
void read_Input();


